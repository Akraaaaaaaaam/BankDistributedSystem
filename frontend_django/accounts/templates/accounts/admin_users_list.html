{% extends "accounts/base.html" %}
{% block title %}Utilisateurs • Admin • AtlasBank{% endblock %}

{% block content %}

<div class="grid cols-3">
    <div class="card">
        <h3 class="card-title">Utilisateurs</h3>

        <div class="muted">
            Total : <strong>{{ total_users }}</strong><br>
            Admins : <strong>{{ total_admins }}</strong><br>
            Clients : <strong>{{ total_clients }}</strong>
        </div>
    </div>

    <div class="card">
        <h3 class="card-title">Statuts</h3>
        <p class="card-sub">Actifs / inactifs</p>
        <div class="muted">
            Actifs : <strong>{{ active_count }}</strong><br>
            Inactifs : <strong>{{ inactive_count }}</strong>
        </div>
    </div>

    <div class="card">
        <h3 class="card-title">Actions</h3>

        <div class="row" style="margin-top:10px;">
            <a class="btn ghost" href="{% url 'admin_stats' %}">Stats</a>
            <a class="btn ghost" href="{% url 'admin_all_transactions' %}">Transactions</a>

            {% if user.is_super_admin %}
            <a class="btn primary" href="{% url 'admin_create_admin' %}">+ Créer admin</a>
            {% endif %}
        </div>
    </div>
</div>

<div class="spacer"></div>

<div class="card">
    <h2 class="card-title">Recherche par Filtres</h2>

    <form method="get" class="row" novalidate>
        <div class="field">
            <label class="muted" for="q">Recherche</label>
            <input class="input" id="q" type="text" name="q" value="{{ q }}" placeholder="admin, client1, ...">
        </div>

        <div class="field">
            <label class="muted" for="role">Rôle</label>
            <select id="role" name="role">
                <option value="ALL" {% if role_filter == "ALL" %}selected{% endif %}>Tous</option>
                <option value="CLIENT" {% if role_filter == "CLIENT" %}selected{% endif %}>Client</option>
                <option value="ADMIN" {% if role_filter == "ADMIN" %}selected{% endif %}>Admin</option>
            </select>
        </div>

        <div class="field">
            <label class="muted" for="active">Statut</label>
            <select id="active" name="active">
                <option value="ALL" {% if active_filter == "ALL" %}selected{% endif %}>Tous</option>
                <option value="true" {% if active_filter == "true" %}selected{% endif %}>Actifs</option>
                <option value="false" {% if active_filter == "false" %}selected{% endif %}>Inactifs</option>
            </select>
        </div>

        <div class="field" style="justify-content:flex-end">
            <button class="btn primary" type="submit">Filtrer</button>
            <a class="btn ghost" href="{% url 'admin_users_list' %}">Reset</a>
        </div>
    </form>
</div>

<div class="spacer"></div>

<div class="card">
    <h2 class="card-title">Liste des utilisateurs</h2>

    <table class="table">
        <thead>
        <tr>
            <th>Username</th>
            <th>Rôle</th>
            <th>Statut</th>
            <th>Actions</th>
        </tr>
        </thead>
        <tbody>
        {% for u in users %}
        <tr>
            <td><strong>{{ u.username }}</strong></td>
            <td><span class="badge">{{ u.role }}</span></td>
            <td>
                {% if u.active %}
                <span class="badge">Actif</span>
                {% else %}
                <span class="badge">Inactif</span>
                {% endif %}
            </td>
            <td style="white-space:nowrap; display:flex; gap:8px; align-items:center; flex-wrap:wrap;">

                {% if u.client_id %}
                <a class="btn ghost" href="{% url 'admin_client_accounts' u.client_id %}">Comptes</a>
                {% endif %}

                {% if u.active %}
                <form method="post" action="{% url 'admin_set_user_active' u.id %}" style="display:inline;">
                    {% csrf_token %}
                    <input type="hidden" name="action" value="deactivate">
                    <button class="btn danger" type="submit" data-confirm="Désactiver cet utilisateur ?">
                        Désactiver
                    </button>
                </form>
                {% else %}
                <form method="post" action="{% url 'admin_set_user_active' u.id %}" style="display:inline;">
                    {% csrf_token %}
                    <input type="hidden" name="action" value="activate">
                    <button class="btn primary" type="submit" data-confirm="Activer cet utilisateur ?">
                        Activer
                    </button>
                </form>
                {% endif %}

                {% if user.is_super_admin %}
                <a class="btn ghost" href="{% url 'admin_reset_password' u.id %}"
                   data-confirm="Réinitialiser le mot de passe de cet utilisateur ?">
                    Reset password
                </a>
                <form method="post" action="{% url 'admin_delete_user' u.id %}" style="display:inline;">
                    {% csrf_token %}
                    <button class="btn danger"
                            onclick="return confirm('Supprimer définitivement cet utilisateur ? Cette action est irréversible !');">
                        Supprimer
                    </button>
                </form>

                {% endif %}
            </td>
        </tr>
        {% empty %}
        <tr><td colspan="4">Aucun utilisateur trouvé.</td></tr>
        {% endfor %}
        </tbody>
    </table>
</div>

{% endblock %}
